<!doctype html>
<html lang="en-GB">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="../index.css">
    <link rel="stylesheet" href="lta-contracts-table.css">

    <link rel="icon" type="image/svg+xml" href="../logo-red.svg">
    <title>joofer.j/lta-rail-civil-contracts-list</title>

    <style type="text/css">
        html {
        	background: #000000;
        	font-family: Ubuntu;
        	font-weight: 500;
        	color: #FFFFFF;
        }
        			
        main {
            padding: 1.5rem;
        }
        
        h1 {
            margin-bottom: 1.5rem;
        }

		#tagFilters {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			margin-bottom: 1rem;
		}
		
		.tag-button {
			padding: 0.3rem 0.6rem;
			border: 1px solid var(--borderColor-muted, #444);
			border-radius: 5px;
			font-family: Ubuntu;
			background-color: var(--bgColor-muted, #222);
			cursor: pointer;
			font-size: 0.9rem;
			color: white;
			font-weight: 400;
		}
		
		.tag-button.active {
			font-family: Ubuntu;
			background-color: var(--bgColor-accent, #555);
			font-weight: 600;
		}
    </style>
</head>

<body>
    <div id="header">
        <span>joofer.j/lta-rail-civil-contracts-list</span>
        <div id="header-right">
            <a id="home" href="https://jooferj.github.io">Back to Menu</a>
        </div>
    </div>

    <main>
        <h1>LTA Rail Civil Contracts List</h1>

        <div id="tagFilters"></div>
        <div id="lineFilters"></div>


        <div class="table-container">
            <table class="contracts-table" id="contractsTable">
                <thead>
                    <tr>
                        <th>Contract No.</th>
                        <th>Title</th>
                        <th>Tenderer</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Results Date</th>
                        <th>Notes</th>
                        <th>Tags</th>
                        <th>Lines</th>
                    </tr>
                </thead>

                <tbody>
                    <!-- Table rows will be generated by JS -->
                </tbody>
            </table>
        </div>
    </main>

    <script>
        let contractsData = [];
          let activeTags = new Set();
          let activeLines = new Set();
        
          // ðŸŽ¨ Central color map for lines & tags
          const badgeColors = {
			  // LINES
			  "EWL": "#009739",
			  "NSL": "#DA291C",
			  "NEL": "#9B26B6",
			  "CCL": "#FF9E1B",
			  "DTL": "#0057B7",
			  "TEL": "#9B5A1A",
			  "JRL": "#00A6B6",
			  "CRL": "#95D606",
			  "BPLRT": "#748477",
			  "SPLRT": "#748477",
			  "RTSL": "#97CEEB",
			  
			  // TAGS
			  "placeholder": "#ffffff",
          };
        
          // Return badge HTML
          function badgeHTML(label, type) {
            const color = badgeColors[label] || (type === "line" ? "#005f99" : "#666");
            return `<span class="badge" style="background-color:${color}">${label}</span>`;
          }
        
          async function loadContracts() {
            const response = await fetch("contracts.json");
            contractsData = await response.json();
        
            // Sort contracts by contractNo
            contractsData.sort((a, b) =>
              a.contractNo.localeCompare(b.contractNo, undefined, {
                numeric: true,
                sensitivity: "base"
              })
            );
        
            renderFilters();
            renderTable();
          }
        
          function renderFilters() {
            const lineContainer = document.getElementById("lineFilters");
            const tagContainer = document.getElementById("tagFilters");
            lineContainer.innerHTML = "<h3>Filter by Line</h3>";
            tagContainer.innerHTML = "<h3>Filter by Tag</h3>";
        
            // Collect unique lines & tags
            const allLines = [...new Set(contractsData.flatMap(c => c.lines || []))].sort();
            const allTags = [...new Set(contractsData.flatMap(c => c.tags || []))].sort();
        
            // Render line buttons
            allLines.forEach(line => {
              const button = document.createElement("button");
              button.textContent = line;
              button.className = "tag-button";
              button.style.backgroundColor = badgeColors[line] || "#005f99";
              button.addEventListener("click", () => toggleFilter(line, "line", button));
              lineContainer.appendChild(button);
            });
        
            // Render tag buttons
            allTags.forEach(tag => {
              const button = document.createElement("button");
              button.textContent = tag;
              button.className = "tag-button";
              button.style.backgroundColor = badgeColors[tag] || "#666";
              button.addEventListener("click", () => toggleFilter(tag, "tag", button));
              tagContainer.appendChild(button);
            });
          }
        
          function toggleFilter(value, type, button) {
            const set = type === "line" ? activeLines : activeTags;
            if (set.has(value)) {
              set.delete(value);
              button.classList.remove("active");
            } else {
              set.add(value);
              button.classList.add("active");
            }
            renderTable();
          }
        
          function renderTable() {
            const tbody = document.querySelector("#contractsTable tbody");
            tbody.innerHTML = "";
        
            contractsData.forEach(item => {
              const itemTags = item.tags || [];
              const itemLines = item.lines || [];
        
              // Check line filters
              if (activeLines.size > 0) {
                if (![...activeLines].every(line => itemLines.includes(line))) {
                  return;
                }
              }
        
              // Check tag filters
              if (activeTags.size > 0) {
                let passesTags = [...activeTags].every(tag => {
                  if (itemTags.includes(tag)) return true;
                  const tagLine = tag.match(/^[A-Z]+/);
                  return itemTags.length === 0 && tagLine && itemLines.includes(tagLine[0]);
                });
                if (!passesTags) return;
              }
        
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${item.contractNo || ""}</td>
                <td>${item.title || ""}</td>
                <td>${item.tenderer || ""}</td>
                <td>${item.startDate || ""}</td>
                <td>${item.endDate || ""}</td>
                <td>${item.resultsDate || ""}</td>
                <td>${item.notes || ""}</td>
                <td>${itemTags.map(t => badgeHTML(t, "tag")).join(" ")}</td>
                <td>${itemLines.map(l => badgeHTML(l, "line")).join(" ")}</td>
              `;
              tbody.appendChild(row);
            });
          }
        
          loadContracts();
    </script>
</body>

</html>
